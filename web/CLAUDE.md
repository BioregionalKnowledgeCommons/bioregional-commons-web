# CLAUDE.md â€” bioregional-commons-web/web

## Auth Architecture

### Files
- `src/lib/auth/config.server.ts` â€” RP + JWT config from env vars
- `src/lib/auth/db.server.ts` â€” `pg.Pool` for `bkc_auth` database
- `src/lib/auth/session.server.ts` â€” JWT create/get/destroy, challenge store/consume
- `src/lib/auth/require-session.server.ts` â€” `requireSession()` + `requireSteward(nodeId)` guards
- `src/lib/auth/verify-session-edge.ts` â€” Lightweight JWT verify for edge middleware (no DB)
- `src/lib/auth/client.ts` â€” Client-side register/login/logout/fetchSession using `@simplewebauthn/browser`
- `src/middleware.ts` â€” Edge middleware protecting `/commons/api/*` routes
- `src/types/auth.ts` â€” `AuthUser`, `SessionPayload` types
- `src/components/auth/AuthDialog.tsx` â€” Registration + login dialog with WebAuthn
- `src/components/auth/AuthProvider.tsx` â€” React context providing `useAuth()` hook
- `src/components/auth/UserMenu.tsx` â€” Header user avatar / sign-in button
- `src/app/api/auth/` â€” 6 auth API routes (register options/verify, login options/verify, session GET/DELETE)
- `migrations/001_auth_tables.sql` â€” Schema: users, credentials, challenges, sessions, commons_memberships

### Key Patterns
- **Transactional registration**: User + credential INSERT wrapped in a DB transaction. If credential fails, user row rolls back (no orphans).
- **Challenge type enforcement**: `consumeChallenge("registration")` won't accept an `"authentication"` challenge and vice versa. Prevents challenge replay across flows.
- **Dual-layer JWT validation**: Edge middleware does fast signature-only check (no DB). Route handlers call `requireSteward()` which does full DB session lookup (revocation, expiry) + role check.
- **Cookie scoping**: `bkc_session` cookie scoped to `path: "/commons"` so it's only sent on commons routes.

<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

### Feb 26, 2026

| ID | Time | T | Title | Read |
|----|------|---|-------|------|
| #11072 | 12:16 PM | ðŸ”µ | Web dashboard documentation gaps identified across all major docs | ~490 |
</claude-mem-context>